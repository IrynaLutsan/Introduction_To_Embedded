# --- Configuration Variables ---

# The name of the resulting project file (e.g., hello_blink.elf, hello_blink.hex)
TARGET = hello_blink

# Target Microcontroller
MCU = atmega328p

# Clock Frequency (16 MHz for Arduino Uno)
F_CPU = 16000000UL

# Programmer settings for flashing the chip
PROGRAMMER_TYPE = arduino

# Port where your board is connected
PORT = /dev/cu.usbmodem144301

# Baud rate for Arduino bootloader programming
BAUD_RATE = 115200

# --- Toolchain Definitions ---

# Use avr-gcc and avr-objcopy from the installed toolchain
CC = avr-gcc
OBJCOPY = avr-objcopy
AVRDUDE = avrdude
# New: Utility to dump assembly code from the .elf file
OBJDUMP = avr-objdump

# --- Compilation and Linking Flags ---

# CFLAGS: Added -gstabs for debugging info and -Wa,-ahls for assembly listing
# -Wa,-ahls: tells the assembler to generate a list file (assembly listing)
CFLAGS = -mmcu=$(MCU) -I. -D_GNU_SOURCE -DF_CPU=$(F_CPU) -Os -std=gnu99 -Wall -Wextra -gstabs -Wa,-ahls

# LDFLAGS: Added -Wl,-Map=$(TARGET).map to generate the map file
LDFLAGS = -mmcu=$(MCU) -Wl,-gc-sections -Wl,-Map=$(TARGET).map

# --- File Definitions ---

SRC = $(wildcard *.c)
OBJ = $(SRC:.c=.o)
# List files generated by the -Wa,-ahls flag during compilation
LST = $(SRC:.c=.lst)

# --- Main Targets ---

# Updated default target to include the map and assembly files
all: $(TARGET).elf $(TARGET).hex $(TARGET).map $(LST)

# 1. Compile and Link: Create the executable file (.elf) and the .map file
$(TARGET).elf: $(OBJ)
	@echo "Linking..."
	$(CC) $(LDFLAGS) $^ -o $@

# 2. Compile: Create the object files (.o) and the assembly list files (.lst)
%.o: %.c
	@echo "Compiling $<..."
	$(CC) $(CFLAGS) -c $< -o $@

# 3. Convert: Create the flashable Intel Hex file (.hex)
$(TARGET).hex: $(TARGET).elf
	@echo "Creating Hex File..."
	$(OBJCOPY) -O ihex -R .eeprom $< $@

# New Target: Generate the disassembled assembly output from the ELF file
# This is a useful alternative to the .lst files for a pure disassembly view.
$(TARGET).s: $(TARGET).elf
	@echo "Creating Assembly Dump..."
	$(OBJDUMP) -S $< > $@

# New Target: Explicitly list the Map file, which is generated during linking
$(TARGET).map: $(TARGET).elf
	@echo "Map file generated during linking."

# 4. Program: Flash the .hex file to the microcontroller
program: $(TARGET).hex
	@echo "Flashing $(TARGET).hex to $(MCU) via $(PROGRAMMER_TYPE) on $(PORT)..."
	$(AVRDUDE) -c $(PROGRAMMER_TYPE) -p $(MCU) -P $(PORT) -b $(BAUD_RATE) -U flash:w:$<:i

# --- Utility Targets ---

# Clean up all generated files
clean:
	@echo "Cleaning up..."
	rm -f $(TARGET).elf $(TARGET).hex $(OBJ) $(TARGET).map $(LST) $(TARGET).s
